%This code is for senior project water level sensor, trying to trigger valve
// Pins
const int sensorPin = A0;
const int valvePin  = 8;   // D8 -> ULN IN1 (OUT1 -> solenoid)

// Tuning (adjust based on readings)
const int ON_THRESHOLD  = 850;  // open valve when above this
const int OFF_THRESHOLD = 800;  // close valve when below this
const unsigned long CONFIRM_MS = 700; // debounce time

// Sampling
const int SAMPLES = 10;  // averaged per reading

// State
bool valveOn = false;
unsigned long conditionStart = 0;

int readAveraged(int pin, int n) {
  long sum = 0;
  for (int i = 0; i < n; i++) {
    sum += analogRead(pin);
    delay(2);
  }
  return (int)(sum / n);
}

void setup() {
  pinMode(valvePin, OUTPUT);
  digitalWrite(valvePin, LOW);
  Serial.begin(115200);  // ✅ turn on Serial Monitor
  Serial.println("System starting... check water level readings below");
}

void loop() {
  int level = readAveraged(sensorPin, SAMPLES);
  float voltage = level * (5.0 / 1023.0);  // convert to volts

  // ✅ print readings for debugging
  Serial.print("Sensor raw: ");
  Serial.print(level);
  Serial.print("  |  Voltage: ");
  Serial.print(voltage, 2);
  Serial.print(" V  |  Valve: ");
  Serial.println(valveOn ? "OPEN" : "CLOSED");

  unsigned long now = millis();

  if (!valveOn) {
    if (level >= ON_THRESHOLD) {
      if (conditionStart == 0) conditionStart = now;
      if (now - conditionStart >= CONFIRM_MS) {
        valveOn = true;
        digitalWrite(valvePin, HIGH);
        Serial.println("VALVE -> ON");
        conditionStart = 0;
      }
    } else {
      conditionStart = 0;
    }
  } else {
    if (level <= OFF_THRESHOLD) {
      if (conditionStart == 0) conditionStart = now;
      if (now - conditionStart >= CONFIRM_MS) {
        valveOn = false;
        digitalWrite(valvePin, LOW);
        Serial.println("VALVE -> OFF");
        conditionStart = 0;
      }
    } else {
      conditionStart = 0;
    }
  }

  delay(500);  // half-second updates
}
